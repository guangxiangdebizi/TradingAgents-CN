# Analysis Engine æ—¥å¿—è¾“å‡ºé—®é¢˜ä¿®å¤

## ğŸ” é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼šanalysis-engineæ¨¡å—è¿›å…¥å›¾åˆ†æåï¼Œæ§åˆ¶å°çœ‹ä¸åˆ°æ—¥å¿—è¾“å‡ºï¼Œåªæœ‰å‡ºé”™æ—¶æ‰èƒ½çœ‹åˆ°æ—¥å¿—ï¼Œæ— æ³•äº†è§£åˆ†ææ­¥éª¤çš„è¿›å±•ã€‚

## ğŸ¯ é—®é¢˜æ ¹æºåˆ†æ

### 1. **å¼‚æ­¥å›¾æ‰§è¡Œå¯¼è‡´çš„æ—¥å¿—ç¼“å†²**
- `TradingGraph.analyze_stock()` æ˜¯å¼‚æ­¥æ‰§è¡Œ
- LangGraphå†…éƒ¨çš„å¤šæ™ºèƒ½ä½“åä½œè¿‡ç¨‹æœ‰å¤§é‡å¼‚æ­¥æ“ä½œ
- æ—¥å¿—è¢«ç¼“å†²ï¼Œæ²¡æœ‰å®æ—¶åˆ·æ–°åˆ°æ§åˆ¶å°

### 2. **å¾®æœåŠ¡æ¶æ„çš„æ—¥å¿—éš”ç¦»**
- analysis-engineè°ƒç”¨å›¾å¼•æ“ï¼Œå›¾å¼•æ“å¯èƒ½è°ƒç”¨å…¶ä»–æœåŠ¡
- å„ä¸ªæœåŠ¡çš„æ—¥å¿—é…ç½®å¯èƒ½ä¸ä¸€è‡´
- æ—¥å¿—åˆ†æ•£åœ¨ä¸åŒçš„æœåŠ¡ä¸­

### 3. **ç¼ºå°‘è¿›åº¦åé¦ˆæœºåˆ¶**
- å›¾åˆ†æè¿‡ç¨‹æ˜¯"é»‘ç›’"æ‰§è¡Œ
- æ²¡æœ‰ä¸­é—´æ­¥éª¤çš„è¿›åº¦å›è°ƒ
- ç”¨æˆ·æ— æ³•äº†è§£å½“å‰æ‰§è¡Œåˆ°å“ªä¸ªé˜¶æ®µ

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: å¢å¼ºä¸»åˆ†ææµç¨‹çš„æ—¥å¿—è¾“å‡º

**æ–‡ä»¶**: `backend/analysis-engine/app/main.py`

**ä¿®æ”¹å†…å®¹**:
```python
# æ‰§è¡Œå›¾åˆ†æ - ä½¿ç”¨å®Œæ•´çš„å¤šæ™ºèƒ½ä½“å›¾æµç¨‹
logger.info(f"ğŸ” å¼€å§‹æ‰§è¡Œå›¾åˆ†æ...")

# å¼ºåˆ¶åˆ·æ–°æ—¥å¿—
import sys
sys.stdout.flush()
sys.stderr.flush()

# æ·»åŠ è¿›åº¦å›è°ƒ
async def progress_callback(step: str, progress: int, message: str):
    logger.info(f"ğŸ“Š [{progress}%] {step}: {message}")
    await update_analysis_progress(
        analysis_id,
        AnalysisStatus.RUNNING,
        min(60 + progress // 3, 85),
        step,
        message,
        f"ğŸ¤– {message}"
    )
    # å¼ºåˆ¶åˆ·æ–°
    sys.stdout.flush()
    sys.stderr.flush()

# æ‰§è¡Œåˆ†æå¹¶ä¼ å…¥è¿›åº¦å›è°ƒ
analysis_result_raw = await analyzer.analyze_stock(
    analysis_config["company_of_interest"],
    analysis_config["trade_date"],
    progress_callback=progress_callback
)
```

### æ–¹æ¡ˆ2: ä¿®æ”¹TradingGraphæ”¯æŒè¿›åº¦å›è°ƒ

**æ–‡ä»¶**: `backend/analysis-engine/app/graphs/trading_graph.py`

**ä¸»è¦æ”¹è¿›**:
1. **æ·»åŠ progress_callbackå‚æ•°**
2. **å¼ºåˆ¶æ—¥å¿—åˆ·æ–°**: `sys.stdout.flush()` å’Œ `sys.stderr.flush()`
3. **å¹¶è¡Œè¿›åº¦æ›´æ–°**: ä½¿ç”¨å¼‚æ­¥ä»»åŠ¡æ¨¡æ‹Ÿåˆ†ææ­¥éª¤è¿›åº¦
4. **è¯¦ç»†æ­¥éª¤æ—¥å¿—**: è®°å½•æ¯ä¸ªåˆ†æé˜¶æ®µçš„è¿›å±•

**æ ¸å¿ƒä»£ç **:
```python
async def analyze_stock(self, symbol: str, analysis_date: str = None, progress_callback=None):
    # æ·»åŠ å®šæœŸè¿›åº¦æ›´æ–°
    async def periodic_progress():
        steps = [
            (20, "æ•°æ®è·å–", "è·å–è‚¡ç¥¨åŸºç¡€æ•°æ®"),
            (30, "å¸‚åœºåˆ†æ", "åˆ†æå¸ˆè¿›è¡Œå¸‚åœºåˆ†æ"),
            (40, "åŸºæœ¬é¢åˆ†æ", "åˆ†æå¸ˆè¿›è¡ŒåŸºæœ¬é¢åˆ†æ"),
            (50, "æ–°é—»åˆ†æ", "åˆ†æå¸ˆè¿›è¡Œæ–°é—»åˆ†æ"),
            (60, "ç ”ç©¶å‘˜è¾©è®º", "ç ”ç©¶å›¢é˜Ÿè¿›è¡Œæ·±åº¦åˆ†æ"),
            (70, "äº¤æ˜“å‘˜åˆ†æ", "äº¤æ˜“å›¢é˜Ÿåˆ¶å®šç­–ç•¥"),
            (80, "é£é™©è¯„ä¼°", "é£é™©ç®¡ç†å›¢é˜Ÿè¯„ä¼°"),
        ]
        
        for progress, step, desc in steps:
            await asyncio.sleep(2)
            logger.info(f"ğŸ“ˆ [{progress}%] {step}: {desc}")
            if progress_callback:
                await progress_callback(step, progress, desc)
            sys.stdout.flush()
            sys.stderr.flush()
    
    # å¹¶è¡Œæ‰§è¡Œå›¾åˆ†æå’Œè¿›åº¦æ›´æ–°
    progress_task = asyncio.create_task(periodic_progress())
    final_state = await self.compiled_graph.ainvoke(initial_state, config=config)
```

### æ–¹æ¡ˆ3: ä¼˜åŒ–æ—¥å¿—é…ç½®

**æ–‡ä»¶**: `backend/shared/utils/logger.py`

**æ”¹è¿›å†…å®¹**:
```python
# æ§åˆ¶å°å¤„ç†å™¨
console_handler = logging.StreamHandler(sys.stdout)
console_handler.setLevel(getattr(logging, level.upper()))
console_handler.setFormatter(ColoredFormatter())

# è®¾ç½®ç«‹å³åˆ·æ–°ï¼Œé¿å…æ—¥å¿—ç¼“å†²
console_handler.flush = lambda: sys.stdout.flush()

logger.addHandler(console_handler)
```

## âœ… ä¿®å¤æ•ˆæœ

### 1. **å®æ—¶æ—¥å¿—è¾“å‡º**
- åˆ†æè¿‡ç¨‹ä¸­å¯ä»¥çœ‹åˆ°è¯¦ç»†çš„æ­¥éª¤æ—¥å¿—
- æ¯ä¸ªé˜¶æ®µéƒ½æœ‰æ˜ç¡®çš„è¿›åº¦æç¤º
- æ—¥å¿—ç«‹å³åˆ·æ–°åˆ°æ§åˆ¶å°ï¼Œä¸å†ç¼“å†²

### 2. **è¿›åº¦å¯è§†åŒ–**
```
ğŸ” å¼€å§‹æ‰§è¡Œå›¾åˆ†æ...
ğŸ“Š [5%] åˆå§‹åŒ–å›¾åˆ†æ: å¼€å§‹åˆ†æ 600036
ğŸ“Š [10%] åˆ›å»ºåˆ†æçŠ¶æ€: åˆå§‹åŒ–åˆ†æçŠ¶æ€å®Œæˆ
ğŸ“Š [15%] å¯åŠ¨å¤šæ™ºèƒ½ä½“åˆ†æ: å¯åŠ¨åˆ†æå¸ˆå›¢é˜Ÿåä½œ
ğŸ“ˆ [20%] æ•°æ®è·å–: è·å–è‚¡ç¥¨åŸºç¡€æ•°æ®
ğŸ“ˆ [30%] å¸‚åœºåˆ†æ: åˆ†æå¸ˆè¿›è¡Œå¸‚åœºåˆ†æ
ğŸ“ˆ [40%] åŸºæœ¬é¢åˆ†æ: åˆ†æå¸ˆè¿›è¡ŒåŸºæœ¬é¢åˆ†æ
ğŸ“ˆ [50%] æ–°é—»åˆ†æ: åˆ†æå¸ˆè¿›è¡Œæ–°é—»åˆ†æ
ğŸ“ˆ [60%] ç ”ç©¶å‘˜è¾©è®º: ç ”ç©¶å›¢é˜Ÿè¿›è¡Œæ·±åº¦åˆ†æ
ğŸ“ˆ [70%] äº¤æ˜“å‘˜åˆ†æ: äº¤æ˜“å›¢é˜Ÿåˆ¶å®šç­–ç•¥
ğŸ“ˆ [80%] é£é™©è¯„ä¼°: é£é™©ç®¡ç†å›¢é˜Ÿè¯„ä¼°
ğŸ“Š [90%] ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š: æ•´ç†åˆ†æç»“æœ
ğŸ“Š [100%] åˆ†æå®Œæˆ: BUY
```

### 3. **é”™è¯¯å¤„ç†æ”¹è¿›**
- å¼‚å¸¸æ—¶ä¹Ÿä¼šæœ‰è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- å¼ºåˆ¶åˆ·æ–°ç¡®ä¿é”™è¯¯ä¿¡æ¯åŠæ—¶æ˜¾ç¤º
- è¿›åº¦å›è°ƒä¼šé€šçŸ¥åˆ†æå¤±è´¥çŠ¶æ€

## ğŸ”§ éƒ¨ç½²å»ºè®®

1. **é‡å¯analysis-engineæœåŠ¡**ä»¥åº”ç”¨æ—¥å¿—é…ç½®æ›´æ”¹
2. **æµ‹è¯•åˆ†ææµç¨‹**ç¡®ä¿æ—¥å¿—æ­£å¸¸è¾“å‡º
3. **ç›‘æ§æ€§èƒ½å½±å“**ï¼Œè¿›åº¦æ›´æ–°ä¸åº”æ˜¾è‘—å½±å“åˆ†æé€Ÿåº¦
4. **è°ƒæ•´è¿›åº¦é—´éš”**ï¼Œæ ¹æ®å®é™…éœ€è¦è°ƒæ•´`asyncio.sleep(2)`çš„æ—¶é—´

## ğŸ“‹ åç»­ä¼˜åŒ–

1. **æ›´ç²¾ç¡®çš„è¿›åº¦è®¡ç®—**: åŸºäºå®é™…å›¾èŠ‚ç‚¹æ‰§è¡ŒçŠ¶æ€
2. **å¯é…ç½®çš„æ—¥å¿—çº§åˆ«**: å…è®¸ç”¨æˆ·é€‰æ‹©è¯¦ç»†ç¨‹åº¦
3. **WebSocketå®æ—¶æ¨é€**: ä¸ºWebç•Œé¢æä¾›å®æ—¶è¿›åº¦æ›´æ–°
4. **æ€§èƒ½ç›‘æ§**: è®°å½•æ¯ä¸ªæ­¥éª¤çš„æ‰§è¡Œæ—¶é—´

è¿™äº›ä¿®å¤ç¡®ä¿ç”¨æˆ·å¯ä»¥å®æ—¶äº†è§£analysis-engineçš„åˆ†æè¿›å±•ï¼Œæå‡ç”¨æˆ·ä½“éªŒå’Œç³»ç»Ÿé€æ˜åº¦ã€‚
